<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Focus Flow</title>
    <style>
        :root {
            --bg-color: #F4F5F0;
            --text-color: #58595B;
            --focus-color: #8CA6A8;
            --short-break-color: #A7BFA5;
            --long-break-color: #Ceb3b3;
            --current-theme: var(--focus-color);
            --modal-bg: rgba(255, 255, 255, 0.95);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            transition: background-color 1s ease, color 0.5s ease;
            overflow: hidden;
            padding: 60px 30px 40px 30px;
            box-sizing: border-box;
        }

        .icon {
            width: 24px;
            height: 24px;
            stroke: currentColor;
            stroke-width: 1.5;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        /* 頂部區域 */
        .top-header {
            width: 100%;
            display: flex;
            justify-content: flex-end;
            position: absolute;
            top: 50px;
            right: 30px;
            z-index: 10;
        }

        .settings-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.6;
            padding: 10px;
        }

        .top-section {
            text-align: center;
            margin-top: 15vh;
        }

        #status-label {
            font-size: 1rem;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 15px;
            opacity: 0.7;
            font-weight: 400;
        }

        #timer-display {
            font-size: 6rem;
            font-weight: 200;
            letter-spacing: -1px;
            margin-bottom: 10px;
            font-variant-numeric: tabular-nums;
            line-height: 1;
        }

        #song-info {
            height: 20px;
            font-size: 0.9rem;
            opacity: 0.6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
            margin: 0 auto;
        }

        /* 控制區 */
        .control-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 320px;
            gap: 30px;
        }

        .main-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
        }

        .mode-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.4;
            transition: opacity 0.3s;
        }

        .mode-btn.active {
            opacity: 1;
            color: var(--current-theme);
        }

        .btn-main {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: var(--current-theme);
            color: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, background 0.5s;
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1);
        }

        .btn-main:active { transform: scale(0.96); }

        .volume-container {
            width: 80%;
            display: flex;
            align-items: center;
            gap: 15px;
            opacity: 0.8;
        }
        
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            height: 2px;
            background: rgba(0,0,0,0.1);
            outline: none;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--text-color);
            cursor: pointer;
            border: 2px solid var(--bg-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* 檔案上傳區 */
        .upload-section {
            width: 100%;
            max-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .file-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 5px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-color);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .file-btn-left {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .file-btn-left .icon { opacity: 0.6; width: 18px; height: 18px; }
        .file-status { font-size: 0.75rem; opacity: 0.5; }
        input[type="file"] { display: none; }

        /* 設定模態框 (Modal) */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.2);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-overlay.open {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: var(--bg-color);
            padding: 30px;
            border-radius: 20px;
            width: 80%;
            max-width: 300px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .modal-title {
            font-size: 1.2rem;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: center;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .setting-item label { font-size: 0.9rem; opacity: 0.8; }

        .setting-input {
            width: 60px;
            padding: 8px;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            text-align: center;
            background: white;
            font-size: 1rem;
            color: var(--text-color);
        }

        .btn-save {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: var(--text-color);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <div class="top-header">
        <button class="settings-btn" id="settings-btn">
            <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </button>
    </div>

    <div class="top-section">
        <div id="status-label">Focus</div>
        <div id="timer-display">25:00</div>
        <div id="song-info">Select music to start</div>
    </div>
    
    <div class="control-section">
        <div class="main-controls">
            <button class="mode-btn active" id="shuffle-btn" onclick="togglePlayMode()">
                <svg class="icon" id="icon-shuffle" viewBox="0 0 24 24"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>
                <svg class="icon" id="icon-loop" viewBox="0 0 24 24" style="display:none;"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
            </button>

            <button id="main-btn" class="btn-main">
                <svg class="icon" id="play-icon" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                <svg class="icon" id="pause-icon" viewBox="0 0 24 24" style="display:none"><line x1="10" y1="4" x2="10" y2="20"></line><line x1="14" y1="4" x2="14" y2="20"></line></svg>
            </button>

            <div style="width: 24px;"></div>
        </div>
        
        <div class="volume-container">
            <svg class="icon" viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
            <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.8">
            <svg class="icon" viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
        </div>
    </div>

    <div class="upload-section">
        <label class="file-btn" onclick="document.getElementById('focus-files').click()">
            <div class="file-btn-left">
                <svg class="icon" viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
                <span>Focus List</span>
            </div>
            <span id="focus-count" class="file-status">Empty</span>
        </label>
        <label class="file-btn" onclick="document.getElementById('short-files').click()">
            <div class="file-btn-left">
                <svg class="icon" viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
                <span>Short Break</span>
            </div>
            <span id="short-count" class="file-status">Empty</span>
        </label>
        <label class="file-btn" onclick="document.getElementById('long-files').click()">
            <div class="file-btn-left">
                <svg class="icon" viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
                <span>Long Break</span>
            </div>
            <span id="long-count" class="file-status">Empty</span>
        </label>
    </div>

    <input type="file" id="focus-files" multiple>
    <input type="file" id="short-files" multiple>
    <input type="file" id="long-files" multiple>

    <div class="modal-overlay" id="settings-modal">
        <div class="modal-content">
            <div class="modal-title">Timer Settings</div>
            <div class="setting-item">
                <label>Focus (min)</label>
                <input type="number" id="set-focus" class="setting-input" value="25">
            </div>
            <div class="setting-item">
                <label>Short Break (min)</label>
                <input type="number" id="set-short" class="setting-input" value="5">
            </div>
            <div class="setting-item">
                <label>Long Break (min)</label>
                <input type="number" id="set-long" class="setting-input" value="30">
            </div>
            <button class="btn-save" onclick="saveSettings()">Save & Close</button>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <script>
        // --- 核心邏輯變數 ---
        let config = {
            focus: 25,
            short: 5,
            long: 30
        };

        const phases = {
            FOCUS: { name: "Focus Time", color: "var(--focus-color)" },
            SHORT_BREAK: { name: "Short Break", color: "var(--short-break-color)" },
            LONG_BREAK: { name: "Long Break", color: "var(--long-break-color)" }
        };

        let currentPhase = 'FOCUS';
        let pomodoroCount = 0;
        let timer = null;
        let timeLeft = config.focus * 60;
        let isRunning = false;
        let isShuffle = true; // 預設隨機播放
        
        const playlists = { FOCUS: [], SHORT_BREAK: [], LONG_BREAK: [] };
        let currentTrackIndex = -1; // 用於順序播放

        // DOM
        const timerDisplay = document.getElementById('timer-display');
        const statusLabel = document.getElementById('status-label');
        const mainBtn = document.getElementById('main-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const audioPlayer = document.getElementById('audio-player');
        const songInfo = document.getElementById('song-info');
        const volumeSlider = document.getElementById('volume-slider');
        const settingsModal = document.getElementById('settings-modal');
        const shuffleBtn = document.getElementById('shuffle-btn');

        // --- 初始化設定 (讀取 LocalStorage) ---
        function loadSavedSettings() {
            const savedConfig = localStorage.getItem('focusConfig');
            if(savedConfig) {
                config = JSON.parse(savedConfig);
                document.getElementById('set-focus').value = config.focus;
                document.getElementById('set-short').value = config.short;
                document.getElementById('set-long').value = config.long;
            }
            timeLeft = config.focus * 60; // 重置初始時間
            timerDisplay.innerText = formatTime(timeLeft);
        }

        // --- 設定面板邏輯 ---
        document.getElementById('settings-btn').addEventListener('click', () => {
            settingsModal.classList.add('open');
        });

        function saveSettings() {
            const f = parseInt(document.getElementById('set-focus').value) || 25;
            const s = parseInt(document.getElementById('set-short').value) || 5;
            const l = parseInt(document.getElementById('set-long').value) || 30;
            
            config = { focus: f, short: s, long: l };
            localStorage.setItem('focusConfig', JSON.stringify(config));
            
            // 如果目前暫停中，立即更新顯示時間
            if(!isRunning) {
                if(currentPhase === 'FOCUS') timeLeft = config.focus * 60;
                else if(currentPhase === 'SHORT_BREAK') timeLeft = config.short * 60;
                else timeLeft = config.long * 60;
                timerDisplay.innerText = formatTime(timeLeft);
            }
            settingsModal.classList.remove('open');
        }
        
        // 點擊背景關閉 Modal
        settingsModal.addEventListener('click', (e) => {
            if(e.target === settingsModal) settingsModal.classList.remove('open');
        });

        // --- 播放模式切換邏輯 ---
        function togglePlayMode() {
            isShuffle = !isShuffle;
            const iconShuffle = document.getElementById('icon-shuffle');
            const iconLoop = document.getElementById('icon-loop');
            
            if (isShuffle) {
                shuffleBtn.classList.add('active');
                iconShuffle.style.display = 'block';
                iconLoop.style.display = 'none';
            } else {
                shuffleBtn.classList.add('active'); // 保持活躍色
                iconShuffle.style.display = 'none';
                iconLoop.style.display = 'block';
            }
        }

        // --- 核心播放邏輯 ---
        function updateUIColors() {
            const color = phases[currentPhase].color;
            document.documentElement.style.setProperty('--current-theme', color);
            statusLabel.style.color = color;
        }

        function updatePlayButtonState(playing) {
            if (playing) {
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
            } else {
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
            }
        }

        function handleFiles(inputId, phaseKey, countId) {
            document.getElementById(inputId).addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    playlists[phaseKey] = files;
                    document.getElementById(countId).innerText = `${files.length} tracks`;
                    // 重置播放索引
                    if(currentPhase === phaseKey) currentTrackIndex = -1;
                }
            });
        }
        
        handleFiles('focus-files', 'FOCUS', 'focus-count');
        handleFiles('short-files', 'SHORT_BREAK', 'short-count');
        handleFiles('long-files', 'LONG_BREAK', 'long-count');

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function switchPhase() {
            audioPlayer.pause();
            if (currentPhase === 'FOCUS') {
                pomodoroCount++;
                if (pomodoroCount >= 4) {
                    currentPhase = 'LONG_BREAK';
                    pomodoroCount = 0;
                } else {
                    currentPhase = 'SHORT_BREAK';
                }
            } else {
                currentPhase = 'FOCUS';
            }
            
            // 根據設定更新時間
            if(currentPhase === 'FOCUS') timeLeft = config.focus * 60;
            else if(currentPhase === 'SHORT_BREAK') timeLeft = config.short * 60;
            else timeLeft = config.long * 60;

            statusLabel.innerText = phases[currentPhase].name;
            timerDisplay.innerText = formatTime(timeLeft);
            updateUIColors();
            
            // 切換階段時，重置索引，自動開始播放
            currentTrackIndex = -1; 
            playNextSong(currentPhase);
            audioPlayer.play();
            updatePlayButtonState(true);
        }

        function tick() {
            if (timeLeft > 0) {
                timeLeft--;
                timerDisplay.innerText = formatTime(timeLeft);
            } else {
                switchPhase();
            }
        }

        function toggleTimer() {
            if (isRunning) {
                clearInterval(timer);
                audioPlayer.pause();
                updatePlayButtonState(false);
            } else {
                if (playlists[currentPhase].length === 0) {
                    alert(`Please import music for ${phases[currentPhase].name}`);
                    return;
                }
                if(audioPlayer.src === "") {
                    playNextSong(currentPhase);
                }
                timer = setInterval(tick, 1000);
                audioPlayer.play();
                updatePlayButtonState(true);
            }
            isRunning = !isRunning;
        }

        function playNextSong(phase) {
            const list = playlists[phase];
            if (!list || list.length === 0) return;

            let file;
            if (isShuffle) {
                // 隨機模式
                const randomIndex = Math.floor(Math.random() * list.length);
                file = list[randomIndex];
            } else {
                // 順序模式 (循環)
                currentTrackIndex++;
                if (currentTrackIndex >= list.length) {
                    currentTrackIndex = 0; // 回到第一首
                }
                file = list[currentTrackIndex];
            }

            const fileURL = URL.createObjectURL(file);
            audioPlayer.src = fileURL;
            audioPlayer.volume = volumeSlider.value;
            songInfo.innerText = file.name.replace(/\.[^/.]+$/, "");
            
            // 當歌曲結束時，自動播下一首
            audioPlayer.onended = () => {
                if (isRunning) {
                    playNextSong(phase);
                    audioPlayer.play();
                }
            };
        }

        mainBtn.addEventListener('click', toggleTimer);
        volumeSlider.addEventListener('input', (e) => {
            audioPlayer.volume = e.target.value;
        });

        // 啟動
        loadSavedSettings();
        updateUIColors();
    </script>
</body>
</html>
